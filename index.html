<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FEUD MASTER PRO</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=Outfit:wght@900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #020617;
      --card: #0f172a;
      --accent: #2563eb;
      --amber: #f59e0b;
    }
    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background-color: var(--bg);
      color: #f8fafc;
      margin: 0;
      overflow-x: hidden;
    }
    .game-title { font-family: 'Outfit', sans-serif; }
    
    .card-wrap {
      height: 5.5rem;
      perspective: 1200px;
    }
    .card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      transform-style: preserve-3d;
      cursor: pointer;
    }
    .card-wrap.revealed .card-inner { transform: rotateX(180deg); }
    
    .card-front, .card-back {
      position: absolute;
      inset: 0;
      backface-visibility: hidden;
      display: flex;
      align-items: center;
      border-radius: 1rem;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
    }
    
    .card-front {
      background: linear-gradient(145deg, #1e3a8a, #1d4ed8);
      justify-content: center;
      font-size: 2.5rem;
      font-weight: 900;
      color: rgba(255,255,255,0.2);
    }
    
    .card-front.host-mode {
      background: linear-gradient(145deg, #0f172a, #1e293b);
      border: 1px dashed rgba(255,255,255,0.2);
      color: white;
      font-size: 1rem;
      flex-direction: column;
      gap: 0.25rem;
    }

    .card-back {
      background: linear-gradient(145deg, #fbbf24, #f59e0b);
      color: #451a03;
      transform: rotateX(180deg);
      justify-content: space-between;
      padding: 0 1.75rem;
    }

    .btn {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 0.75rem;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.6rem;
    }
    .btn:active:not(:disabled) { transform: scale(0.95); }
    .btn:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }
    .btn-primary { background: var(--accent); color: white; border: 1px solid rgba(255,255,255,0.1); }
    .btn-primary:hover:not(:disabled) { filter: brightness(1.1); box-shadow: 0 0 25px rgba(37, 99, 235, 0.5); }
    .btn-secondary { background: #1e293b; color: white; border: 1px solid #334155; }
    .btn-danger { background: #ef4444; color: white; border: 1px solid rgba(255,255,255,0.1); }
    .btn-ghost { background: transparent; color: #94a3b8; }
    .btn-ghost:hover:not(:disabled) { color: white; background: rgba(255,255,255,0.05); }
    
    .glass {
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    @keyframes buzz-pulse {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); transform: scale(1); }
      50% { transform: scale(1.02); }
      70% { box-shadow: 0 0 0 40px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); transform: scale(1); }
    }
    .buzzer-active { animation: buzz-pulse 2s infinite; }

    @keyframes strike-in {
      0% { transform: scale(0) rotate(-20deg); opacity: 0; }
      40% { transform: scale(1.4) rotate(10deg); opacity: 1; }
      60% { transform: scale(1) rotate(0deg); opacity: 1; }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    @keyframes strike-fade-out {
      0% { opacity: 1; }
      100% { opacity: 0; }
    }
    .strike-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      animation: strike-fade-out 0.3s 1.2s forwards;
    }
    .animate-strike { 
      animation: strike-in 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      filter: drop-shadow(0 0 40px rgba(239, 68, 68, 0.6));
    }
    
    .shimmer {
      background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0) 100%);
      background-size: 200% 100%;
      animation: shimmer 2s infinite linear;
    }
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    .avatar-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      padding: 16px;
      background: #1e293b;
      border-radius: 24px;
      border: 2px solid #334155;
    }
    .avatar-btn {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      border-radius: 12px;
      transition: all 0.2s;
    }
    .avatar-btn:hover { background: #334155; transform: scale(1.1); }
    .avatar-btn.selected { background: #2563eb; transform: scale(1.1); box-shadow: 0 0 20px rgba(37, 99, 235, 0.4); }

    .podium-container {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 30px;
      height: 400px;
      margin-top: 80px;
      perspective: 1000px;
    }
    .podium-place {
      width: 240px;
      border-radius: 2rem 2rem 0 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      padding-bottom: 30px;
      position: relative;
      transition: all 1.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 20px 80px rgba(0,0,0,0.6);
      transform-style: preserve-3d;
    }
    .podium-1 { background: linear-gradient(180deg, #fcd34d, #b45309); height: 100%; z-index: 10; border: 4px solid #fbbf24; }
    .podium-2 { background: linear-gradient(180deg, #e2e8f0, #475569); height: 75%; border: 4px solid #94a3b8; }
    .podium-3 { background: linear-gradient(180deg, #f97316, #7c2d12); height: 60%; border: 4px solid #ea580c; }

    @keyframes confetti-fall {
      0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
    }
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      top: -10px;
      z-index: 100;
      animation: confetti-fall 4s linear infinite;
    }

    .floating-player {
      animation: float-up 2s ease-out forwards;
      opacity: 0;
    }
    @keyframes float-up {
      0% { transform: translateY(20px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

  </style>
  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@19.0.0",
      "react-dom": "https://esm.sh/react-dom@19.0.0",
      "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
      "lucide-react": "https://esm.sh/lucide-react@0.460.0?external=react",
      "@google/genai": "https://esm.sh/@google/genai@1.3.0"
    }
  }
  </script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useCallback, useRef, useMemo } from 'react';
    import { createRoot } from 'react-dom/client';
    import { 
      Play, Shield, ChevronLeft, Zap, X, Plus, Save, Sparkles, Loader2, User, Users, LogOut, Edit3, CheckCircle2, ChevronRightCircle, Trophy, Medal, Star, ArrowLeft, Languages, Trash2, Wand2, PlusCircle, Search
    } from 'lucide-react';
    import { GoogleGenAI, Type } from "@google/genai";

    const AVATARS = ["ðŸ¦", "ðŸ¯", "ðŸ¦’", "ðŸ¦Š", "ðŸ¶", "ðŸ±", "ðŸ¨", "ðŸ¸", "ðŸµ", "ðŸ¦„", "ðŸ¼", "ðŸ¤–", "ðŸ‘»", "ðŸ‘¾", "ðŸ¦–", "ðŸ§", "ðŸ·", "ðŸ¦‹", "ðŸ„", "ðŸ¥‘", "ðŸ™", "ðŸ¦€", "ðŸš€", "ðŸ•", "ðŸ”"];
    const TEAM_PALETTE = ['#2563eb', '#dc2626', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316'];
    const genId = () => Math.random().toString(36).substr(2, 9);

    const TRANSLATIONS = {
      en: {
        app_title: "FEUD PRO",
        join_broadcast: "JOIN BROADCAST",
        create_board: "CREATE BOARD",
        ready_to_play: "Ready to Play?",
        join_desc: "Join the broadcast with your 6-digit code",
        access_code: "Access Code",
        room_code: "ROOM CODE",
        display_name: "Display Name",
        choose_team: "Choose your team",
        customize_avatar: "Customize Avatar",
        back: "Back",
        enter_arena: "Enter Arena",
        broadcasting_from: "BROADCASTING FROM",
        start_game: "START GAME",
        exit: "EXIT",
        strike: "Strike",
        next_question: "Next Question",
        show_results: "Show Results",
        clear_buzzer: "Clear Buzzer",
        wait_for_host: "Stay Ready",
        awaiting_host: "Awaiting host to start broadcast",
        broadcast_ended: "Broadcast Ended",
        thanks_for_playing: "Thank you for playing!",
        live_topic: "Live Topic",
        buzz: "BUZZ",
        mine: "MINE!",
        wait: "WAIT",
        connection_stable: "Connection: Stable",
        final_standings: "Final Standings",
        champions: "CHAMPIONS",
        return_to_menu: "RETURN TO MENU",
        victory: "VICTORY",
        tournament_results: "The Tournament Results",
        rounds: "Rounds",
        ultimate_console: "Ultimate Host Console",
        points: "PTS",
        runner_up: "Runner Up",
        third_place: "3rd Place",
        delete: "Delete",
        save_board: "Save Board",
        generate_ai: "AI Generate",
        ai_theme: "Enter Theme (e.g. Travel, Movies)",
        board_title: "Board Title",
        team_name: "Team Name",
        teams: "Teams",
        add_team: "Add Team",
        add_question: "Add Question",
        question_prompt: "Question Prompt",
        answer: "Answer",
        pts: "Pts",
        generating: "Generating board...",
        save: "Save",
        searching_room: "Searching for broadcast..."
      },
      ru: {
        app_title: "Ð¤Ð¬Ð®Ð” ÐŸÐ Ðž",
        join_broadcast: "Ð’ÐžÐ™Ð¢Ð˜ Ð’ Ð˜Ð“Ð Ð£",
        create_board: "Ð¡ÐžÐ—Ð”ÐÐ¢Ð¬ Ð˜Ð“Ð Ð£",
        ready_to_play: "Ð“Ð¾Ñ‚Ð¾Ð²Ñ‹ Ð¸Ð³Ñ€Ð°Ñ‚ÑŒ?",
        join_desc: "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ 6-Ð·Ð½Ð°Ñ‡Ð½Ñ‹Ð¹ ÐºÐ¾Ð´ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹",
        access_code: "ÐšÐ¾Ð´ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°",
        room_code: "ÐšÐžÐ” ÐšÐžÐœÐÐÐ¢Ð«",
        display_name: "Ð’Ð°ÑˆÐµ Ð¸Ð¼Ñ",
        choose_team: "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ",
        customize_avatar: "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð°Ð²Ð°Ñ‚Ð°Ñ€",
        back: "ÐÐ°Ð·Ð°Ð´",
        enter_arena: "Ð’Ð¾Ð¹Ñ‚Ð¸ Ð½Ð° Ð°Ñ€ÐµÐ½Ñƒ",
        broadcasting_from: "Ð¢Ð ÐÐÐ¡Ð›Ð¯Ð¦Ð˜Ð¯ Ð˜Ð—",
        start_game: "ÐÐÐ§ÐÐ¢Ð¬ Ð˜Ð“Ð Ð£",
        exit: "Ð’Ð«Ð¥ÐžÐ”",
        strike: "ÐŸÑ€Ð¾Ð¼Ð°Ñ…",
        next_question: "Ð¡Ð»ÐµÐ´. Ð²Ð¾Ð¿Ñ€Ð¾Ñ",
        show_results: "Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹",
        clear_buzzer: "Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ ÐºÐ½Ð¾Ð¿ÐºÑƒ",
        wait_for_host: "Ð“Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚ÑŒ",
        awaiting_host: "ÐžÐ¶Ð¸Ð´Ð°Ð¹Ñ‚Ðµ Ð½Ð°Ñ‡Ð°Ð»Ð° Ñ‚Ñ€Ð°Ð½ÑÐ»ÑÑ†Ð¸Ð¸",
        broadcast_ended: "Ð¢Ñ€Ð°Ð½ÑÐ»ÑÑ†Ð¸Ñ Ð¾ÐºÐ¾Ð½Ñ‡ÐµÐ½Ð°",
        thanks_for_playing: "Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð¸Ð³Ñ€Ñƒ!",
        live_topic: "Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ñ‚ÐµÐ¼Ð°",
        buzz: "Ð–ÐœÐ˜!",
        mine: "ÐœÐžÐ!",
        wait: "Ð–Ð”Ð˜",
        connection_stable: "Ð¡Ð²ÑÐ·ÑŒ: Ð¡Ñ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð°",
        final_standings: "Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ ÑÑ‡Ñ‘Ñ‚",
        champions: "Ð§Ð•ÐœÐŸÐ˜ÐžÐÐ«",
        return_to_menu: "Ð’ ÐœÐ•ÐÐ®",
        victory: "ÐŸÐžÐ‘Ð•Ð”Ð",
        tournament_results: "Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ñ‚ÑƒÑ€Ð½Ð¸Ñ€Ð°",
        rounds: "Ð Ð°ÑƒÐ½Ð´Ð¾Ð²",
        ultimate_console: "ÐŸÐ°Ð½ÐµÐ»ÑŒ Ð²ÐµÐ´ÑƒÑ‰ÐµÐ³Ð¾",
        points: "ÐžÐ§Ðš",
        runner_up: "Ð’Ñ‚Ð¾Ñ€Ð¾Ðµ Ð¼ÐµÑÑ‚Ð¾",
        third_place: "Ð¢Ñ€ÐµÑ‚ÑŒÐµ Ð¼ÐµÑÑ‚Ð¾",
        delete: "Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ",
        save_board: "Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ",
        generate_ai: "AI Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ",
        ai_theme: "Ð¢ÐµÐ¼Ð° (Ð½Ð°Ð¿Ñ€. ÐšÐ¸Ð½Ð¾, Ð•Ð´Ð°)",
        board_title: "ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð³Ñ€Ñ‹",
        team_name: "Ð˜Ð¼Ñ ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹",
        teams: "ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹",
        add_team: "ÐÐ¾Ð²Ð°Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°",
        add_question: "ÐÐ¾Ð²Ñ‹Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ",
        question_prompt: "Ð¢ÐµÐºÑÑ‚ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°",
        answer: "ÐžÑ‚Ð²ÐµÑ‚",
        pts: "ÐžÑ‡ÐºÐ¸",
        generating: "Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¸Ð³Ñ€Ñ‹...",
        save: "Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ",
        searching_room: "ÐŸÐ¾Ð¸ÑÐº Ñ‚Ñ€Ð°Ð½ÑÐ»ÑÑ†Ð¸Ð¸..."
      }
    };

    const MOCK_BOARD = {
      id: 'm1',
      title: { en: "Pop Culture Mania", ru: "ÐŸÐ¾Ð¿-ÐºÑƒÐ»ÑŒÑ‚ÑƒÑ€Ð°" },
      teams: [
        { id: 't1', name: { en: "TEAM ALPHA", ru: "ÐÐ›Ð¬Ð¤Ð" }, color: '#2563eb' },
        { id: 't2', name: { en: "TEAM OMEGA", ru: "ÐžÐœÐ•Ð“Ð" }, color: '#dc2626' }
      ],
      questions: [
        {
          id: 'q1',
          prompt: { en: "Name a movie that everyone has seen at least once", ru: "ÐÐ°Ð·Ð¾Ð²Ð¸Ñ‚Ðµ Ñ„Ð¸Ð»ÑŒÐ¼, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð²Ð¸Ð´ÐµÐ» ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ñ…Ð¾Ñ‚Ñ Ð±Ñ‹ Ñ€Ð°Ð·" },
          answers: [
            { id: 'a1', text: { en: "Titanic", ru: "Ð¢Ð¸Ñ‚Ð°Ð½Ð¸Ðº" }, points: 45 },
            { id: 'a2', text: { en: "Star Wars", ru: "Ð—Ð²ÐµÐ·Ð´Ð½Ñ‹Ðµ Ð²Ð¾Ð¹Ð½Ñ‹" }, points: 32 },
            { id: 'a3', text: { en: "The Lion King", ru: "ÐšÐ¾Ñ€Ð¾Ð»ÑŒ Ð›ÐµÐ²" }, points: 18 },
            { id: 'a4', text: { en: "Home Alone", ru: "ÐžÐ´Ð¸Ð½ Ð´Ð¾Ð¼Ð°" }, points: 12 },
            { id: 'a5', text: { en: "Toy Story", ru: "Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¸Ð³Ñ€ÑƒÑˆÐµÐº" }, points: 8 },
            { id: 'a6', text: { en: "Jurassic Park", ru: "ÐŸÐ°Ñ€Ðº Ð®Ñ€ÑÐºÐ¾Ð³Ð¾ Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð°" }, points: 5 }
          ]
        }
      ]
    };

    class SyncService {
      constructor(roomCode, onMessage) {
        this.roomCode = roomCode;
        this.onMessage = onMessage;
        this.id = genId();
        this.storageKey = `feud_v3_room_${roomCode}`;
        this.channel = new BroadcastChannel(`feud_v3_chan_${roomCode}`);
        this.channel.onmessage = (e) => this._receive(e.data);
        this._storageHandler = (e) => {
          if (e.key === this.storageKey && e.newValue) this._receive(JSON.parse(e.newValue));
        };
        window.addEventListener('storage', this._storageHandler);
      }
      _receive(data) { if (data._from !== this.id) this.onMessage(data); }
      send(type, payload = {}) {
        const msg = { type, payload, _from: this.id, _t: Date.now() };
        this.channel.postMessage(msg);
        localStorage.setItem(this.storageKey, JSON.stringify(msg));
      }
      close() {
        this.channel.close();
        window.removeEventListener('storage', this._storageHandler);
      }
    }

    const AvatarPicker = ({ selected, onSelect }) => (
      <div className="avatar-grid max-w-md mx-auto">
        {AVATARS.map(a => (
          <button 
            key={a} 
            onClick={() => onSelect(a)} 
            className={`avatar-btn ${selected === a ? 'selected' : ''}`}
          >
            {a}
          </button>
        ))}
      </div>
    );

    const JoinView = ({ onJoin, onBack, t, lang }) => {
      const [code, setCode] = useState('');
      const [name, setName] = useState('');
      const [avatar, setAvatar] = useState(AVATARS[0]);
      const [teamId, setTeamId] = useState('');
      const [roomData, setRoomData] = useState(null);
      const syncRef = useRef(null);

      useEffect(() => {
        if (code.length === 6) {
          syncRef.current = new SyncService(code, (msg) => {
            if (msg.type === 'HEARTBEAT' || msg.type === 'SYNC') {
               setRoomData(msg.payload);
            }
          });
          syncRef.current.send('REQUEST_SYNC');
          // Send request sync a few more times to ensure host catches it
          const int = setInterval(() => { if (!roomData) syncRef.current?.send('REQUEST_SYNC'); }, 1000);
          return () => { syncRef.current?.close(); clearInterval(int); };
        } else setRoomData(null);
      }, [code, roomData === null]);

      return (
        <div className="min-h-screen flex items-center justify-center p-6 bg-slate-950">
          <div className="w-full max-w-4xl glass p-10 rounded-[2.5rem] shadow-2xl space-y-8 animate-in zoom-in duration-500 overflow-y-auto max-h-[90vh]">
            <div className="text-center space-y-2">
              <div className="inline-flex p-3 bg-blue-600/10 rounded-2xl text-blue-500 mb-2">
                <Zap className="fill-current w-6 h-6" />
              </div>
              <h1 className="text-4xl font-black game-title tracking-tight uppercase">{t('ready_to_play')}</h1>
              <p className="text-slate-500 text-sm">{t('join_desc')}</p>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-10">
              <div className="space-y-6">
                <div className="space-y-2">
                   <p className="text-[10px] font-black uppercase text-slate-500 tracking-widest ml-2">{t('access_code')}</p>
                   <input 
                    type="text" maxLength={6} placeholder={t('room_code')} 
                    className="w-full bg-slate-900/50 p-6 text-center text-4xl font-black rounded-2xl border-2 border-slate-800 focus:border-blue-500 outline-none tracking-widest transition-all" 
                    value={code} onChange={e => setCode(e.target.value.replace(/\D/g,''))} 
                  />
                </div>
                <div className="space-y-2">
                   <p className="text-[10px] font-black uppercase text-slate-500 tracking-widest ml-2">{t('display_name')}</p>
                   <input 
                    type="text" placeholder={t('display_name')} 
                    className="w-full bg-slate-900/50 p-5 rounded-2xl border-2 border-slate-800 outline-none focus:border-blue-500 font-black uppercase text-sm tracking-widest text-center" 
                    value={name} onChange={e => setName(e.target.value)} 
                  />
                </div>
                
                {code.length === 6 && !roomData && (
                   <div className="flex flex-col items-center justify-center p-8 gap-3 text-blue-500/50 bg-slate-900/50 rounded-3xl border border-slate-800 animate-pulse">
                      <Search className="w-6 h-6 animate-bounce" />
                      <span className="text-[10px] font-black uppercase tracking-[0.2em]">{t('searching_room')}</span>
                   </div>
                )}

                {roomData && (
                  <div className="space-y-4 animate-in slide-in-from-top-4">
                    <p className="text-[10px] font-black uppercase text-slate-500 tracking-widest ml-2">{t('choose_team')}</p>
                    <div className="flex flex-wrap gap-4">
                      {roomData.teams.map(tData => (
                        <button 
                          key={tData.id} 
                          onClick={() => setTeamId(tData.id)} 
                          className={`flex-1 min-w-[140px] p-4 rounded-2xl border-4 transition-all font-black text-[10px] uppercase tracking-widest relative overflow-hidden group ${teamId === tData.id ? 'border-white scale-105 shadow-[0_0_30px_rgba(255,255,255,0.2)]' : 'border-transparent opacity-40 hover:opacity-100'}`} 
                          style={{background: tData.color}}
                        >
                          <span className="relative z-10">{typeof tData.name === 'object' ? tData.name[lang] : tData.name}</span>
                          {teamId === tData.id && <div className="absolute top-1 right-1"><CheckCircle2 className="w-4 h-4 text-white" /></div>}
                        </button>
                      ))}
                    </div>
                  </div>
                )}
              </div>
              <div className="space-y-2">
                <p className="text-[10px] font-black uppercase text-slate-500 tracking-widest ml-2 text-center">{t('customize_avatar')}</p>
                <AvatarPicker selected={avatar} onSelect={setAvatar} />
              </div>
            </div>

            <div className="pt-6 grid grid-cols-2 gap-6">
              <button onClick={onBack} className="btn btn-ghost py-6 text-lg uppercase tracking-widest rounded-2xl">{t('back')}</button>
              <button 
                onClick={() => onJoin(code, name, avatar, teamId)} 
                disabled={!roomData || !name || !teamId} 
                className="btn btn-primary py-6 text-xl tracking-tight uppercase shadow-xl rounded-2xl"
              >
                {t('enter_arena')}
              </button>
            </div>
          </div>
        </div>
      );
    };

    const BoardCreator = ({ onSave, onBack, t, lang }) => {
      const [title, setTitle] = useState({ en: '', ru: '' });
      const [teams, setTeams] = useState([
        { id: 't1', name: { en: 'TEAM ALPHA', ru: 'ÐšÐžÐœÐÐÐ”Ð ÐÐ›Ð¬Ð¤Ð' }, color: '#2563eb' },
        { id: 't2', name: { en: 'TEAM OMEGA', ru: 'ÐšÐžÐœÐÐÐ”Ð ÐžÐœÐ•Ð“Ð' }, color: '#dc2626' }
      ]);
      const [questions, setQuestions] = useState([]);
      const [isGenerating, setIsGenerating] = useState(false);
      const [aiTheme, setAiTheme] = useState('');

      const generateAI = async () => {
        if (!aiTheme) return;
        setIsGenerating(true);
        try {
          const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
          const prompt = `Generate a Family Feud game board about "${aiTheme}". 
          Return ONLY JSON in this format:
          {
            "title": { "en": "English Title", "ru": "Russian Title" },
            "questions": [
              {
                "prompt": { "en": "Question in English", "ru": "Question in Russian" },
                "answers": [
                  { "text": { "en": "Ans 1", "ru": "Ans 1 ru" }, "points": 40 },
                  ... usually 4-8 answers
                ]
              },
              ... total 5-8 questions
            ]
          }
          Make questions diverse and answers realistic.`;
          
          const response = await ai.models.generateContent({
            model: 'gemini-3-flash-preview',
            contents: prompt,
            config: { responseMimeType: "application/json" }
          });
          
          const data = JSON.parse(response.text);
          setTitle(data.title);
          setQuestions(data.questions.map(q => ({ ...q, id: genId(), answers: q.answers.map(a => ({ ...a, id: genId() })) })));
        } catch (e) {
          console.error(e);
          alert("AI Generation failed.");
        } finally {
          setIsGenerating(false);
        }
      };

      const addEmptyQuestion = () => {
        setQuestions([...questions, {
          id: genId(),
          prompt: { en: '', ru: '' },
          answers: [{ id: genId(), text: { en: '', ru: '' }, points: 0 }]
        }]);
      };

      const addTeam = () => {
        const nextColor = TEAM_PALETTE[teams.length % TEAM_PALETTE.length];
        setTeams([...teams, { 
          id: genId(), 
          name: { en: `TEAM ${teams.length + 1}`, ru: `ÐšÐžÐœÐÐÐ”Ð ${teams.length + 1}` }, 
          color: nextColor 
        }]);
      };

      const updateTeam = (tid, field, value) => {
        setTeams(teams.map(tm => tm.id === tid ? { ...tm, [field]: value } : tm));
      };

      const updateQuestion = (qid, field, value) => {
        setQuestions(questions.map(q => q.id === qid ? { ...q, [field]: value } : q));
      };

      const handleSave = () => {
        const board = {
          id: genId(),
          title,
          teams,
          questions
        };
        onSave(board);
      };

      return (
        <div className="min-h-screen p-12 bg-slate-950 overflow-y-auto">
          <div className="max-w-4xl mx-auto space-y-12 pb-32">
            <header className="flex justify-between items-center">
              <button onClick={onBack} className="btn btn-secondary px-8"><ArrowLeft className="w-5 h-5" /> {t('back')}</button>
              <h2 className="text-4xl font-black game-title tracking-tighter uppercase">{t('create_board')}</h2>
              <button onClick={handleSave} className="btn btn-primary px-10 py-4 text-lg"><Save className="w-5 h-5" /> {t('save_board')}</button>
            </header>

            <div className="glass p-10 rounded-[3rem] space-y-8">
              <div className="grid grid-cols-2 gap-8">
                 <div className="space-y-2">
                    <p className="text-[10px] font-black uppercase text-slate-500 tracking-widest ml-2">{t('board_title')} (EN)</p>
                    <input type="text" className="w-full bg-slate-900/50 p-5 rounded-2xl border-2 border-slate-800 outline-none focus:border-blue-500" value={title.en} onChange={e => setTitle({...title, en: e.target.value})} />
                 </div>
                 <div className="space-y-2">
                    <p className="text-[10px] font-black uppercase text-slate-500 tracking-widest ml-2">{t('board_title')} (RU)</p>
                    <input type="text" className="w-full bg-slate-900/50 p-5 rounded-2xl border-2 border-slate-800 outline-none focus:border-blue-500" value={title.ru} onChange={e => setTitle({...title, ru: e.target.value})} />
                 </div>
              </div>
            </div>

            <div className="glass p-10 rounded-[3rem] space-y-8">
              <div className="flex justify-between items-center border-b border-white/5 pb-4">
                 <h3 className="text-xl font-bold uppercase tracking-widest">{t('teams')}</h3>
                 <Users className="text-blue-500" />
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {teams.map((tm, idx) => (
                  <div key={tm.id} className="bg-slate-950 p-6 rounded-3xl border border-slate-800 space-y-4 relative group">
                    {teams.length > 2 && (
                      <button onClick={() => setTeams(teams.filter(tItem => tItem.id !== tm.id))} className="absolute top-4 right-4 text-slate-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                         <Trash2 className="w-4 h-4" />
                      </button>
                    )}
                    <div className="flex items-center gap-4">
                       <input type="color" value={tm.color} onChange={e => updateTeam(tm.id, 'color', e.target.value)} className="w-10 h-10 rounded-lg bg-transparent border-none cursor-pointer" />
                       <p className="text-[10px] font-black uppercase text-slate-500 tracking-widest">{t('team_name')} {idx + 1}</p>
                    </div>
                    <div className="space-y-2">
                      <input placeholder="EN Name" className="w-full bg-slate-950 p-3 rounded-xl border border-slate-800 text-sm" value={tm.name.en} onChange={e => updateTeam(tm.id, 'name', {...tm.name, en: e.target.value})} />
                      <input placeholder="RU Name" className="w-full bg-slate-950 p-3 rounded-xl border border-slate-800 text-sm" value={tm.name.ru} onChange={e => updateTeam(tm.id, 'name', {...tm.name, ru: e.target.value})} />
                    </div>
                  </div>
                ))}
                <button onClick={addTeam} className="border-4 border-dashed border-slate-800 rounded-3xl p-8 flex flex-col items-center justify-center gap-3 text-slate-500 hover:border-blue-500 hover:text-blue-500 transition-all">
                   <PlusCircle className="w-8 h-8" />
                   <span className="font-black uppercase text-xs tracking-widest">{t('add_team')}</span>
                </button>
              </div>
            </div>

            <div className="glass p-10 rounded-[3rem] space-y-6">
              <div className="flex justify-between items-center">
                <h3 className="text-xl font-bold uppercase tracking-widest">{t('generate_ai')}</h3>
                <Wand2 className="text-blue-500" />
              </div>
              <div className="flex gap-4">
                <input type="text" placeholder={t('ai_theme')} className="flex-1 bg-slate-900/50 p-4 rounded-xl border border-slate-800 outline-none focus:border-blue-500" value={aiTheme} onChange={e => setAiTheme(e.target.value)} />
                <button onClick={generateAI} disabled={isGenerating} className="btn btn-primary px-8">
                  {isGenerating ? <Loader2 className="animate-spin" /> : t('generate_ai')}
                </button>
              </div>
            </div>

            <div className="space-y-6">
              {questions.map((q, qIdx) => (
                <div key={q.id} className="glass p-8 rounded-[2.5rem] space-y-6 relative border-l-8 border-blue-500">
                  <button onClick={() => setQuestions(questions.filter(qu => qu.id !== q.id))} className="absolute top-4 right-4 p-2 text-slate-500 hover:text-red-500"><X /></button>
                  <div className="grid grid-cols-1 gap-4">
                    <input placeholder={`${t('question_prompt')} (EN)`} className="w-full bg-slate-900/50 p-4 rounded-xl border border-slate-800 font-bold" value={q.prompt.en} onChange={e => updateQuestion(q.id, 'prompt', {...q.prompt, en: e.target.value})} />
                    <input placeholder={`${t('question_prompt')} (RU)`} className="w-full bg-slate-900/50 p-4 rounded-xl border border-slate-800 font-bold" value={q.prompt.ru} onChange={e => updateQuestion(q.id, 'prompt', {...q.prompt, ru: e.target.value})} />
                  </div>
                  <div className="space-y-3">
                    {q.answers.map((ans, aIdx) => (
                      <div key={ans.id} className="grid grid-cols-[1fr_1fr_80px_40px] gap-3 items-center">
                        <input placeholder={t('answer')} className="bg-slate-950 p-3 rounded-lg border border-slate-800 text-sm" value={ans.text.en} onChange={e => {
                          const newAns = q.answers.map(a => a.id === ans.id ? {...a, text: {...a.text, en: e.target.value}} : a);
                          updateQuestion(q.id, 'answers', newAns);
                        }} />
                        <input placeholder={t('answer')} className="bg-slate-950 p-3 rounded-lg border border-slate-800 text-sm" value={ans.text.ru} onChange={e => {
                          const newAns = q.answers.map(a => a.id === ans.id ? {...a, text: {...a.text, ru: e.target.value}} : a);
                          updateQuestion(q.id, 'answers', newAns);
                        }} />
                        <input type="number" placeholder={t('pts')} className="bg-slate-950 p-3 rounded-lg border border-slate-800 text-sm text-center" value={ans.points} onChange={e => {
                          const newAns = q.answers.map(a => a.id === ans.id ? {...a, points: parseInt(e.target.value) || 0} : a);
                          updateQuestion(q.id, 'answers', newAns);
                        }} />
                        <button onClick={() => {
                          const newAns = q.answers.filter(a => a.id !== ans.id);
                          updateQuestion(q.id, 'answers', newAns);
                        }} className="text-slate-600 hover:text-red-500"><Trash2 className="w-4 h-4" /></button>
                      </div>
                    ))}
                    <button onClick={() => {
                      const newAns = [...q.answers, { id: genId(), text: { en: '', ru: '' }, points: 0 }];
                      updateQuestion(q.id, 'answers', newAns);
                    }} className="text-xs font-bold text-blue-500 flex items-center gap-1"><PlusCircle className="w-3 h-3" /> {t('add_question')}</button>
                  </div>
                </div>
              ))}
              <button onClick={addEmptyQuestion} className="w-full py-10 rounded-[3rem] border-4 border-dashed border-slate-800 hover:border-blue-500 hover:bg-blue-500/5 transition-all flex flex-col items-center gap-2 text-slate-500 hover:text-blue-500 font-black">
                <Plus className="w-10 h-10" />
                {t('add_question').toUpperCase()}
              </button>
            </div>
          </div>
        </div>
      );
    };

    const ConfettiComponent = () => {
      const pieces = useMemo(() => [...Array(50)].map((_, i) => ({
        id: i,
        left: Math.random() * 100,
        delay: Math.random() * 4,
        color: ['#fcd34d', '#3b82f6', '#ef4444', '#10b981', '#a855f7'][Math.floor(Math.random() * 5)]
      })), []);
      
      return (
        <div className="fixed inset-0 pointer-events-none">
          {pieces.map(p => (
            <div 
              key={p.id} 
              className="confetti" 
              style={{ 
                left: `${p.left}%`, 
                animationDelay: `${p.delay}s`,
                backgroundColor: p.color
              }} 
            />
          ))}
        </div>
      );
    };

    const AnswerTileComponent = ({ answer, index, onClick, isHost, t, lang }) => {
      if (!answer) return <div className="h-24 rounded-2xl bg-slate-900/30 border border-slate-800 border-dashed"></div>;
      const isRevealed = answer.revealed;
      const text = typeof answer.text === 'object' ? answer.text[lang] : answer.text;

      return (
        <div className={`card-wrap ${isRevealed ? 'revealed' : ''}`} onClick={onClick}>
          <div className="card-inner">
            <div className={`card-front ${isHost ? 'host-mode' : ''}`}>
              {!isHost ? (
                <span className="opacity-30">{index + 1}</span>
              ) : (
                <>
                  <span className="text-blue-400 font-black text-sm uppercase tracking-widest">{index + 1}</span>
                  <span className="font-bold text-center px-2 text-sm">{text}</span>
                  <span className="text-slate-500 font-black text-[10px]">{answer.points} {t('points')}</span>
                </>
              )}
            </div>
            <div className="card-back">
              <span className="font-extrabold text-xl truncate uppercase tracking-tight">{text}</span>
              <div className="h-10 w-px bg-amber-900/20 mx-2"></div>
              <span className="font-black text-4xl">{answer.points}</span>
            </div>
          </div>
        </div>
      );
    };

    function GameEngine({ board, onExit, t, lang }) {
      const [state, setState] = useState({
        qIdx: 0,
        scores: {}, 
        roundBank: 0, 
        strikes: 0,
        buzzedId: null,
        players: [],
        revealedIds: [],
        roomCode: Math.floor(100000 + Math.random() * 900000).toString(),
        gameStatus: 'LOBBY',
        showStrikeAnim: false
      });
      const syncRef = useRef(null);
      const currentQ = board.questions[state.qIdx];

      const syncAllInt = useCallback(() => {
        if (!syncRef.current) return;
        syncRef.current.send('SYNC', {
          prompt: currentQ?.prompt || "",
          teams: board.teams,
          scores: state.scores,
          roundBank: state.roundBank,
          strikes: state.strikes,
          buzzedId: state.buzzedId,
          gameStatus: state.gameStatus,
          answers: currentQ?.answers.map((a, i) => ({
            index: i,
            revealed: state.revealedIds.includes(a.id),
            text: a.text,
            points: a.points
          })) || []
        });
      }, [currentQ, state, board.teams]);

      useEffect(() => {
        syncRef.current = new SyncService(state.roomCode, (msg) => {
          if (msg.type === 'REQUEST_SYNC') syncAllInt();
          if (msg.type === 'JOIN') setState(s => s.players.find(p => p.id === msg.payload.id) ? s : ({...s, players: [...s.players, msg.payload]}));
          if (msg.type === 'UPDATE_PROFILE') setState(s => ({...s, players: s.players.map(p => p.id === msg.payload.id ? {...p, ...msg.payload} : p)}));
          if (msg.type === 'BUZZ' && state.gameStatus === 'PLAYING') {
             setState(s => {
                if (s.buzzedId) return s;
                return {...s, buzzedId: msg.payload.id};
             });
          }
        });
        const beat = setInterval(() => syncRef.current.send('HEARTBEAT', { teams: board.teams, gameStatus: state.gameStatus, prompt: currentQ?.prompt || "" }), 2000);
        return () => { clearInterval(beat); syncRef.current?.close(); };
      }, [state.roomCode, state.gameStatus, currentQ, board.teams, syncAllInt]);

      useEffect(() => { syncAllInt(); }, [state.revealedIds, state.gameStatus, state.strikes, state.buzzedId, state.scores, state.qIdx, state.roundBank, syncAllInt]);

      const onToggleReveal = (aid) => {
        const isRevealed = state.revealedIds.includes(aid);
        const answer = currentQ.answers.find(a => a.id === aid);
        const pts = answer?.points || 0;
        
        setState(s => {
          const newRevealedIds = isRevealed ? s.revealedIds.filter(id => id !== aid) : [...s.revealedIds, aid];
          let newScores = { ...s.scores };
          let newRoundBank = isRevealed ? s.roundBank - pts : s.roundBank + pts;

          if (!isRevealed && s.buzzedId) {
             const buzzedPlayer = s.players.find(p => p.id === s.buzzedId);
             if (buzzedPlayer) {
                const teamId = buzzedPlayer.teamId;
                newScores[teamId] = (newScores[teamId] || 0) + pts;
                newRoundBank = 0; 
             }
          }

          return {
            ...s, 
            revealedIds: newRevealedIds,
            roundBank: newRoundBank,
            scores: newScores
          };
        });
      };

      const onStrike = () => {
        setState(s => ({...s, strikes: (s.strikes + 1) % 4, buzzedId: null, showStrikeAnim: true }));
        setTimeout(() => setState(s => ({...s, showStrikeAnim: false})), 1500);
      };

      const onNext = () => {
        if (state.qIdx + 1 < board.questions.length) {
          const nextIdx = state.qIdx + 1;
          setState(s => ({...s, qIdx: nextIdx, revealedIds: [], strikes: 0, buzzedId: null, gameStatus: 'PLAYING', roundBank: 0}));
        } else {
          setState(s => ({...s, gameStatus: 'PODIUM', buzzedId: null}));
        }
      };

      if (state.gameStatus === 'PODIUM') {
        const sortedTeams = [...board.teams].sort((a, b) => (state.scores[b.id] || 0) - (state.scores[a.id] || 0));
        return (
          <div className="min-h-screen flex flex-col items-center justify-center p-12 bg-slate-950 overflow-hidden relative">
            <ConfettiComponent />
            <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--accent)_0%,_transparent_70%)] opacity-30"></div>
            <div className="text-center z-10 space-y-4 animate-in fade-in duration-1000">
               <h1 className="text-8xl font-black game-title tracking-tighter italic text-white drop-shadow-[0_0_30px_rgba(255,255,255,0.3)]">{t('victory')}</h1>
               <p className="text-blue-400 uppercase tracking-[1em] font-black text-sm">{t('tournament_results')}</p>
            </div>
            <div className="podium-container z-10">
               {sortedTeams[2] && (
                 <div className="podium-place podium-3 animate-in slide-in-from-bottom-20 duration-1000 delay-400">
                    <div className="absolute -top-32 flex flex-col items-center space-y-2">
                       <div className="flex -space-x-4">
                          {state.players.filter(p => p.teamId === sortedTeams[2].id).map((p, idx) => (
                             <div key={p.id} className="w-14 h-14 bg-slate-800 rounded-2xl flex items-center justify-center text-3xl border-4 border-slate-700 shadow-2xl floating-player" style={{animationDelay: `${idx * 200}ms`}}>
                                {p.avatar}
                                <span className="absolute -bottom-8 whitespace-nowrap text-[8px] font-bold text-slate-400 uppercase">{p.name}</span>
                             </div>
                          ))}
                       </div>
                    </div>
                    <Medal className="w-12 h-12 text-amber-700 mb-4" />
                    <span className="text-2xl font-black text-slate-100 mb-1 truncate px-4 text-center">{sortedTeams[2].name[lang]}</span>
                    <span className="text-4xl font-black text-white">{state.scores[sortedTeams[2].id] || 0}</span>
                    <span className="absolute bottom-4 uppercase font-black tracking-widest text-slate-400 text-[8px]">{t('third_place')}</span>
                 </div>
               )}
               {sortedTeams[1] && (
                 <div className="podium-place podium-2 animate-in slide-in-from-bottom-20 duration-1000 delay-200">
                    <div className="absolute -top-40 flex flex-col items-center space-y-2">
                       <div className="flex -space-x-4">
                          {state.players.filter(p => p.teamId === sortedTeams[1].id).map((p, idx) => (
                             <div key={p.id} className="w-16 h-16 bg-slate-800 rounded-2xl flex items-center justify-center text-4xl border-4 border-slate-700 shadow-2xl floating-player" style={{animationDelay: `${idx * 200}ms`}}>
                                {p.avatar}
                                <span className="absolute -bottom-8 whitespace-nowrap text-[10px] font-bold text-slate-400 uppercase">{p.name}</span>
                             </div>
                          ))}
                       </div>
                    </div>
                    <Medal className="w-16 h-16 text-slate-300 mb-4" />
                    <span className="text-3xl font-black text-slate-100 mb-1 truncate px-4 text-center">{sortedTeams[1].name[lang]}</span>
                    <span className="text-5xl font-black text-white">{state.scores[sortedTeams[1].id] || 0}</span>
                    <span className="absolute bottom-4 uppercase font-black tracking-widest text-slate-400 text-[10px]">{t('runner_up')}</span>
                 </div>
               )}
               {sortedTeams[0] && (
                 <div className="podium-place podium-1 animate-in slide-in-from-bottom-20 duration-700">
                    <div className="absolute -top-48 flex flex-col items-center space-y-4">
                       <div className="flex -space-x-6">
                          {state.players.filter(p => p.teamId === sortedTeams[0].id).map((p, idx) => (
                             <div key={p.id} className="w-20 h-20 bg-amber-800 rounded-3xl flex items-center justify-center text-5xl border-4 border-amber-400 shadow-[0_0_40px_rgba(245,158,11,0.5)] floating-player" style={{animationDelay: `${idx * 200 + 500}ms`}}>
                                {p.avatar}
                                <span className="absolute -bottom-10 whitespace-nowrap text-xs font-black text-amber-300 uppercase tracking-tighter">{p.name}</span>
                             </div>
                          ))}
                       </div>
                    </div>
                    <Trophy className="w-24 h-24 text-amber-200 mb-6 drop-shadow-[0_0_30px_rgba(252,211,77,0.8)] animate-bounce" />
                    <span className="text-4xl font-black text-amber-50 mb-2 truncate px-4 text-center">{sortedTeams[0].name[lang]}</span>
                    <span className="text-7xl font-black text-white mb-4">{state.scores[sortedTeams[0].id] || 0}</span>
                    <div className="bg-amber-900/60 px-8 py-3 rounded-full border-2 border-amber-400 shadow-2xl">
                       <span className="uppercase font-black tracking-[0.4em] text-amber-200 text-sm">{t('champions')}</span>
                    </div>
                 </div>
               )}
            </div>
            <div className="mt-24 z-10 flex gap-8">
               <button onClick={onExit} className="btn bg-white text-slate-950 px-16 py-6 text-xl rounded-3xl shadow-[0_20px_40px_rgba(255,255,255,0.2)] hover:scale-105 transition-all flex items-center gap-4">
                  <ArrowLeft className="w-6 h-6" /> {t('return_to_menu')}
               </button>
            </div>
          </div>
        );
      }

      const currentPrompt = typeof currentQ?.prompt === 'object' ? currentQ.prompt[lang] : currentQ?.prompt;

      if (state.gameStatus === 'LOBBY') return (
        <div className="min-h-screen flex flex-col items-center justify-center p-12 bg-slate-950 space-y-16">
          <div className="text-center space-y-6">
            <h2 className="text-blue-500 font-black uppercase tracking-[0.5em] text-xs">{t('broadcasting_from')}</h2>
            <div className="bg-white text-slate-950 px-24 py-12 rounded-[4rem] shadow-[0_0_120px_rgba(255,255,255,0.1)] relative">
               <h1 className="text-[12rem] leading-none font-black tracking-tighter">{state.roomCode}</h1>
               <div className="absolute -top-4 -right-4 bg-blue-600 text-white p-4 rounded-full shadow-2xl"><Users className="w-8 h-8" /></div>
            </div>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10 w-full max-w-7xl">
            {board.teams.map(tData => (
              <div key={tData.id} className="glass p-10 rounded-[3rem] border-t-8 space-y-6" style={{borderColor: tData.color}}>
                <div className="flex justify-between items-center border-b border-white/5 pb-4">
                  <h3 className="text-xl font-black uppercase truncate pr-2" style={{color: tData.color}}>{typeof tData.name === 'object' ? tData.name[lang] : tData.name}</h3>
                  <span className="text-[10px] font-bold text-slate-500 uppercase whitespace-nowrap">{state.players.filter(p => p.teamId === tData.id).length} Connected</span>
                </div>
                <div className="grid grid-cols-1 gap-4">
                  {state.players.filter(p => p.teamId === tData.id).map(p => (
                    <div key={p.id} className="bg-slate-900/50 p-5 rounded-2xl border border-slate-800 flex items-center gap-4 animate-in fade-in zoom-in">
                      <span className="text-3xl">{p.avatar}</span>
                      <span className="font-bold text-base truncate uppercase tracking-tight">{p.name}</span>
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </div>
          <div className="flex gap-8">
            <button onClick={() => setState(s => ({...s, gameStatus: 'PLAYING'}))} className="btn btn-primary px-24 py-8 text-3xl tracking-tight rounded-[2rem] shadow-2xl">{t('start_game')}</button>
            <button onClick={onExit} className="btn btn-secondary px-10 rounded-2xl">{t('exit')}</button>
          </div>
        </div>
      );

      return (
        <div className="min-h-screen p-10 flex flex-col space-y-12 animate-in fade-in duration-700 relative overflow-hidden">
          {state.showStrikeAnim && (
            <div className="strike-overlay">
               <div className="flex gap-16">
                  {[...Array(state.strikes === 0 ? 3 : state.strikes)].map((_, i) => (
                    <div key={i} className="animate-strike">
                      <X className="w-[28rem] h-[28rem] text-red-600 fill-current" strokeWidth={10} />
                    </div>
                  ))}
               </div>
            </div>
          )}
          <div className="flex flex-wrap justify-center items-center max-w-7xl mx-auto w-full gap-6">
             {board.teams.map(tData => (
                <div key={tData.id} className="glass p-6 rounded-[2.5rem] border-b-8 min-w-[200px] text-center shadow-2xl relative" style={{borderBottomColor: tData.color}}>
                   <p className="text-6xl font-black mb-1 leading-none">{state.scores[tData.id] || 0}</p>
                   <p className="text-[10px] font-black uppercase text-slate-500 tracking-[0.2em] truncate px-2">{typeof tData.name === 'object' ? tData.name[lang] : tData.name}</p>
                </div>
             ))}
          </div>
          <div className="max-w-6xl mx-auto w-full flex-1 flex flex-col space-y-8 relative">
            <div className="glass p-16 rounded-[4rem] text-center relative border-2 border-white/5 shadow-2xl overflow-hidden">
               <div className="absolute inset-0 opacity-10 bg-[radial-gradient(circle_at_center,_var(--accent)_0%,_transparent_70%)]"></div>
               <h2 className="text-5xl font-black italic drop-shadow-2xl leading-tight tracking-tight text-white relative">"{currentPrompt}"</h2>
               {state.buzzedId && (
                  <div className="absolute inset-0 bg-amber-400 flex flex-col items-center justify-center animate-in zoom-in duration-300 rounded-[4rem] z-50">
                     <h3 className="text-9xl font-black text-amber-950 uppercase italic mb-8 tracking-tighter">BUZZ!</h3>
                     <div className="flex items-center gap-6 bg-amber-950 text-white px-12 py-6 rounded-[2rem] shadow-2xl border-4 border-amber-800">
                        <span className="text-6xl">{state.players.find(p => p.id === state.buzzedId)?.avatar}</span>
                        <span className="text-4xl font-black uppercase tracking-tight">{state.players.find(p => p.id === state.buzzedId)?.name}</span>
                     </div>
                     <button onClick={() => setState(s => ({...s, buzzedId: null}))} className="mt-10 bg-amber-950 text-white px-8 py-3 rounded-xl font-black uppercase text-xs tracking-widest hover:scale-105 transition-all">{t('clear_buzzer')}</button>
                  </div>
               )}
               <div className="absolute top-8 right-12 flex gap-4">
                  {[...Array(state.strikes)].map((_, i) => <X key={i} className="text-red-600 w-16 h-16 fill-current animate-in zoom-in" strokeWidth={5} />)}
               </div>
            </div>
            <div className="grid grid-cols-2 gap-6">
               {[...Array(8)].map((_, i) => (
                  <AnswerTileComponent 
                    key={i} 
                    index={i} 
                    answer={currentQ.answers[i] ? {...currentQ.answers[i], revealed: state.revealedIds.includes(currentQ.answers[i].id)} : null} 
                    isHost={true}
                    onClick={() => currentQ.answers[i] && onToggleReveal(currentQ.answers[i].id)} 
                    t={t}
                    lang={lang}
                  />
               ))}
            </div>
          </div>
          <div className="fixed bottom-10 right-10 flex gap-6 glass p-6 rounded-3xl shadow-[0_30px_60px_-12px_rgba(0,0,0,0.5)] z-[60]">
             <button onClick={onStrike} className="btn btn-danger w-48 py-5 text-lg uppercase tracking-widest shadow-xl">{t('strike')}</button>
             <button onClick={onNext} className="btn btn-primary w-72 py-5 text-lg flex items-center gap-3 uppercase tracking-tighter shadow-xl">
               {state.qIdx + 1 >= board.questions.length ? t('show_results') : t('next_question')} <ChevronRightCircle className="w-6 h-6" />
             </button>
             <button onClick={onExit} className="btn btn-secondary px-8 shadow-lg"><LogOut className="w-6 h-6" /></button>
          </div>
        </div>
      );
    }

    function PlayerInterface({ code, name: initialName, avatar: initialAvatar, id, teamId, onExit, onUpdate, t, lang }) {
      const [sync, setSync] = useState(null);
      const [status, setStatus] = useState('READY');
      const [isEditing, setIsEditing] = useState(false);
      const [editName, setEditName] = useState(initialName);
      const [editAvatar, setEditAvatar] = useState(initialAvatar);
      
      const syncRef = useRef(null);

      useEffect(() => {
        syncRef.current = new SyncService(code, (msg) => {
          if (msg.type === 'SYNC') setSync(msg.payload);
          if (msg.type === 'HEARTBEAT') setSync(prev => prev ? {...prev, ...msg.payload} : msg.payload);
        });
        syncRef.current.send('JOIN', { name: initialName, avatar: initialAvatar, id, teamId });
        syncRef.current.send('REQUEST_SYNC');
        return () => syncRef.current?.close();
      }, [code, id, teamId]);

      const onBuzz = () => {
        if (!sync || sync.gameStatus !== 'PLAYING' || sync.buzzedId) return;
        setStatus('BUZZED');
        syncRef.current.send('BUZZ', { id });
        setTimeout(() => setStatus('READY'), 3000);
      };

      const handleUpdateProfile = () => {
        onUpdate({ name: editName, avatar: editAvatar });
        syncRef.current.send('UPDATE_PROFILE', { id, name: editName, avatar: editAvatar });
        setIsEditing(false);
      };

      if (!sync) return (
        <div className="min-h-screen flex flex-col items-center justify-center p-8 space-y-8 bg-slate-950 text-center">
           <div className="relative">
              <div className="w-24 h-24 border-8 border-slate-800 border-t-blue-600 rounded-full animate-spin"></div>
              <Zap className="absolute inset-0 m-auto text-blue-500 w-8 h-8 fill-current animate-pulse" />
           </div>
           <p className="font-black uppercase tracking-[0.4em] text-slate-500 animate-pulse text-xs">...</p>
           <button onClick={onExit} className="btn btn-ghost">{t('back')}</button>
        </div>
      );

      const currentPrompt = typeof sync.prompt === 'object' ? sync.prompt[lang] : sync.prompt;

      return (
        <div className="min-h-screen flex flex-col items-center p-8 space-y-12 bg-slate-950">
          <div className="w-full max-w-md glass p-6 rounded-[2.5rem] flex justify-between items-center shadow-2xl border-white/5">
             <div className="flex items-center gap-5">
                <div className="relative">
                  <div className="w-16 h-16 bg-slate-900 rounded-2xl flex items-center justify-center text-5xl shadow-inner">{initialAvatar}</div>
                  <button onClick={() => setIsEditing(!isEditing)} className="absolute -bottom-2 -right-2 bg-blue-600 p-2 rounded-xl border-4 border-slate-950 shadow-xl transition-transform hover:scale-110"><Edit3 className="w-3 h-3 text-white" /></button>
                </div>
                <div className="leading-tight">
                   <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Broadcast {code}</p>
                   <p className="font-black text-xl uppercase tracking-tight text-white">{initialName}</p>
                </div>
             </div>
             <button onClick={onExit} className="btn btn-secondary p-5 rounded-2xl border-white/5"><LogOut className="w-5 h-5" /></button>
          </div>
          {isEditing && (
            <div className="w-full max-w-2xl glass p-10 rounded-[3rem] space-y-8 animate-in slide-in-from-top-6 z-[100] border-blue-500/20 shadow-4xl">
               <div className="space-y-4">
                  <p className="text-[10px] font-black uppercase text-slate-500 tracking-[0.4em] ml-2 text-center">{t('customize_avatar')}</p>
                  <AvatarPicker selected={editAvatar} onSelect={setAvatar => setEditAvatar(setAvatar)} />
                  <input type="text" className="w-full bg-slate-900/50 p-5 rounded-2xl border-2 border-slate-800 font-black uppercase text-center tracking-widest outline-none focus:border-blue-500 transition-all" value={editName} onChange={e => setEditName(e.target.value)} placeholder={t('display_name')} />
               </div>
               <button onClick={handleUpdateProfile} className="btn btn-primary w-full py-5 text-xl tracking-tight shadow-xl uppercase rounded-2xl">{t('save')}</button>
            </div>
          )}
          <div className="w-full max-w-2xl glass rounded-[4.5rem] p-12 text-center space-y-12 shadow-[0_60px_120px_-30px_rgba(0,0,0,0.8)] flex-1 flex flex-col justify-center relative overflow-hidden border-white/5">
             {sync.gameStatus === 'LOBBY' ? (
                <div className="py-24 space-y-10">
                   <Users className="w-16 h-16 text-blue-500 mx-auto" />
                   <h2 className="text-6xl font-black italic tracking-tighter uppercase leading-none">{t('wait_for_host')}</h2>
                   <p className="text-slate-500 uppercase font-black tracking-[0.5em] text-[10px]">{t('awaiting_host')}</p>
                </div>
             ) : sync.gameStatus === 'PODIUM' ? (
                <div className="py-24 space-y-10 animate-in zoom-in">
                   <Trophy className="w-32 h-32 text-amber-500 mx-auto" />
                   <h2 className="text-6xl font-black italic tracking-tighter uppercase leading-none text-amber-100">{t('broadcast_ended')}</h2>
                   <p className="text-slate-400 font-bold tracking-widest uppercase">{t('thanks_for_playing')}</p>
                </div>
             ) : (
                <div className="space-y-16 animate-in fade-in duration-500">
                  <div className="space-y-4">
                    <p className="text-[10px] font-black text-blue-500 uppercase tracking-[0.5em] animate-pulse">{t('live_topic')}</p>
                    <h2 className="text-5xl font-black italic text-blue-50 leading-tight drop-shadow-lg">"{currentPrompt}"</h2>
                  </div>
                  <div className="flex justify-center relative">
                     <button onClick={onBuzz} disabled={sync.gameStatus !== 'PLAYING' || (sync.buzzedId && sync.buzzedId !== id)} className={`w-80 h-80 rounded-full border-[24px] text-7xl font-black transition-all shadow-[0_0_120px_rgba(0,0,0,0.6)] relative z-20 ${sync.buzzedId === id ? 'bg-amber-500 border-amber-300 text-amber-950 scale-110 rotate-3' : sync.gameStatus === 'PLAYING' && !sync.buzzedId ? 'bg-red-600 border-red-500 buzzer-active active:scale-90 hover:scale-[1.02]' : 'bg-slate-900 border-slate-800 opacity-20 grayscale cursor-not-allowed'}`}>
                        <span className="drop-shadow-2xl">{sync.buzzedId === id ? t('mine') : sync.buzzedId ? t('wait') : t('buzz')}</span>
                     </button>
                  </div>
                </div>
             )}
          </div>
        </div>
      );
    }

    function App() {
      const [view, setView] = useState('HOME');
      const [boards, setBoards] = useState([]);
      const [activeBoard, setActiveBoard] = useState(null);
      const [pInfo, setPInfo] = useState({ code: '', name: '', avatar: AVATARS[0], teamId: '', id: genId() });
      const [lang, setLang] = useState('en');

      useEffect(() => {
        const saved = localStorage.getItem('feud_v3_boards');
        setBoards(saved ? JSON.parse(saved) : [MOCK_BOARD]);
      }, []);

      const saveBoard = (newBoard) => {
        const updated = [newBoard, ...boards];
        setBoards(updated);
        localStorage.setItem('feud_v3_boards', JSON.stringify(updated));
        setView('HOME');
      };

      const deleteBoard = (id) => {
        if (!confirm("Are you sure?")) return;
        const updated = boards.filter(b => b.id !== id);
        setBoards(updated);
        localStorage.setItem('feud_v3_boards', JSON.stringify(updated));
      };

      const updatePInfo = (updates) => setPInfo(prev => ({...prev, ...updates}));

      const t = (key) => TRANSLATIONS[lang][key] || key;

      if (view === 'CREATOR') return <BoardCreator t={t} lang={lang} onBack={() => setView('HOME')} onSave={saveBoard} />;
      if (view === 'JOIN') return <JoinView t={t} lang={lang} onBack={() => setView('HOME')} onJoin={(c, n, a, tid) => { setPInfo({ code: c, name: n, avatar: a, teamId: tid, id: genId() }); setView('PLAYER'); }} />;
      if (view === 'PLAYER') return <PlayerInterface t={t} lang={lang} {...pInfo} onUpdate={updatePInfo} onExit={() => setView('HOME')} />;
      if (view === 'PLAY') return <GameEngine t={t} lang={lang} board={activeBoard} onExit={() => setView('HOME')} />;

      return (
        <div className="min-h-screen flex flex-col bg-slate-950 text-white selection:bg-blue-600/30">
          <header className="p-8 flex justify-between items-center glass sticky top-0 z-50 border-b border-white/5 backdrop-blur-3xl">
             <div className="flex items-center gap-4">
                <div className="p-3 bg-blue-600 rounded-2xl shadow-[0_0_30px_rgba(37,99,235,0.4)]"><Zap className="fill-current w-6 h-6" /></div>
                <h1 className="text-3xl font-black game-title tracking-tighter italic">FEUD PRO</h1>
             </div>
             <div className="flex gap-4 items-center">
                <button onClick={() => setLang(l => l === 'en' ? 'ru' : 'en')} className="btn btn-ghost p-3 rounded-xl border border-white/5 bg-white/5 hover:bg-white/10 transition-all flex items-center gap-2">
                  <Languages className="w-5 h-5" />
                  <span className="uppercase font-black text-xs">{lang === 'en' ? 'RU' : 'EN'}</span>
                </button>
                <button onClick={() => setView('JOIN')} className="btn btn-secondary px-10 py-4 rounded-2xl border-white/5 hover:border-white/10 transition-all font-black text-xs uppercase tracking-widest">{t('join_broadcast')}</button>
                <button onClick={() => setView('CREATOR')} className="btn btn-primary px-10 py-4 rounded-2xl shadow-xl transition-all hover:scale-105 font-black text-xs uppercase tracking-widest"><Plus className="w-4 h-4" /> {t('create_board')}</button>
             </div>
          </header>

          <main className="flex-1 flex flex-col items-center py-24 px-6 space-y-24">
             <div className="text-center relative max-w-6xl">
                <div className="absolute inset-0 bg-blue-600/10 blur-[200px] rounded-full"></div>
                <h2 className="text-[18rem] font-black game-title leading-none tracking-tighter italic opacity-95 drop-shadow-[0_20px_80px_rgba(0,0,0,0.8)] select-none">FEUD</h2>
                <div className="flex items-center justify-center gap-6 mt-4">
                  <div className="h-px w-24 bg-gradient-to-r from-transparent to-blue-500"></div>
                  <p className="text-blue-500 font-black uppercase tracking-[1.5em] text-xs font-semibold italic">{t('ultimate_console')}</p>
                  <div className="h-px w-24 bg-gradient-to-l from-transparent to-blue-500"></div>
                </div>
             </div>

             <div className="max-w-7xl w-full grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-12 z-10">
                {boards.map(b => (
                   <div key={b.id} className="glass p-12 rounded-[4rem] cursor-pointer hover:border-blue-500/50 transition-all hover:scale-[1.05] group shadow-[0_40px_100px_-30px_rgba(0,0,0,1)] relative overflow-hidden">
                      <div className="absolute top-4 right-4 z-20" onClick={(e) => { e.stopPropagation(); deleteBoard(b.id); }}>
                         <button className="p-4 bg-red-600/10 hover:bg-red-600 text-red-500 hover:text-white rounded-2xl transition-all opacity-0 group-hover:opacity-100"><Trash2 className="w-5 h-5" /></button>
                      </div>
                      <div className="absolute inset-0 bg-gradient-to-br from-blue-600/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity" onClick={() => { setActiveBoard(b); setView('PLAY'); }}></div>
                      <div className="flex justify-between items-start mb-12 relative z-10 pointer-events-none">
                         <h3 className="text-4xl font-black italic uppercase leading-tight group-hover:text-blue-400 transition-colors tracking-tighter">{typeof b.title === 'object' ? b.title[lang] : b.title}</h3>
                         <div className="p-6 bg-slate-950 rounded-[2rem] group-hover:bg-blue-600 group-hover:scale-110 transition-all shadow-2xl"><Play className="fill-current w-8 h-8" /></div>
                      </div>
                      <div className="flex justify-between items-center border-t border-white/5 pt-10 relative z-10 pointer-events-none">
                         <div className="flex flex-col">
                            <span className="text-[10px] font-black uppercase text-slate-500 tracking-[0.4em] mb-1">{t('rounds')}</span>
                            <span className="text-2xl font-black text-white">{b.questions.length}</span>
                         </div>
                         <div className="flex -space-x-5">
                            {b.teams.map(teamData => <div key={teamData.id} className="w-12 h-12 rounded-full border-4 border-slate-900 shadow-2xl relative transition-transform group-hover:-translate-y-2" style={{background: teamData.color}}></div>)}
                         </div>
                      </div>
                   </div>
                ))}
             </div>
          </main>
          
          <footer className="p-20 border-t border-white/5 text-slate-800 font-black text-[10px] uppercase tracking-[1em] text-center opacity-50">
             FEUD MASTER PRO &bull; THE ULTIMATE EXPERIENCE &bull; 2025
          </footer>
        </div>
      );
    }

    createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>